<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <title>我的心意</title>
    <style>
        :root{ 
            --glow-r1:10px; 
            --glow-r2:22px;
            --msg-font-size: clamp(12px, 2.5vmin, 18px);
            --title-font-size: clamp(16px, 3.5vmin, 24px);
            --button-font-size: clamp(12px, 2vmin, 16px);
        }
        
        html,body{
            height:100%;margin:0;overflow:hidden;
            font-family:"微软雅黑",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
            transition:background 1s;
            background:
                radial-gradient(800px 400px at 50% 45%, rgba(255,255,255,.65), rgba(255,255,255,0) 60%),
                radial-gradient(circle at 50% 45%, #fff4f7 0%, #c9eaff 100%);
        }
        
        /* 小屏幕优化 */
        @media (max-width: 768px) {
            html,body {
                background:
                    radial-gradient(500px 250px at 50% 45%, rgba(255,255,255,.65), rgba(255,255,255,0) 60%),
                    radial-gradient(circle at 50% 45%, #fff4f7 0%, #c9eaff 100%);
            }
        }
        
        @media (max-width: 480px) {
            html,body {
                background:
                    radial-gradient(300px 150px at 50% 45%, rgba(255,255,255,.65), rgba(255,255,255,0) 60%),
                    radial-gradient(circle at 50% 45%, #fff4f7 0%, #c9eaff 100%);
            }
        }

        body.dark{
            background:
                radial-gradient(800px 400px at 50% 45%, rgba(18,18,18,.8), rgba(0,0,0,0) 60%),
                radial-gradient(circle at 50% 45%, #121212 0%, #000000 100%);
            color:#eee;
        }
        
        @media (max-width: 768px) {
            body.dark {
                background:
                    radial-gradient(500px 250px at 50% 45%, rgba(18,18,18,.8), rgba(0,0,0,0) 60%),
                    radial-gradient(circle at 50% 45%, #121212 0%, #000000 100%);
            }
        }
        
        @media (max-width: 480px) {
            body.dark {
                background:
                    radial-gradient(300px 150px at 50% 45%, rgba(18,18,18,.8), rgba(0,0,0,0) 60%),
                    radial-gradient(circle at 50% 45%, #121212 0%, #000000 100%);
            }
        }
        
        body.dark.eco{ --glow-r1:6px; --glow-r2:14px; }

        .stage{
            position:relative;
            width:100%;
            height:100%;
            /* 限制最大尺寸 */
            max-width: 100vw;
            max-height: 100vh;
        }

        .msg{
            position:absolute;
            left:50%;
            top:50%;
            padding:8px 12px;
            border-radius:12px;
            color:#fff;
            font-weight:700;
            font-size: var(--msg-font-size);
            text-shadow:0 2px 8px rgba(0,0,0,.28);
            opacity:0;
            transform:translate(-50%,-50%) translate(var(--dx),var(--dy)) scale(.75) rotate(var(--rot));
            animation: flight var(--dur) cubic-bezier(.25,.7,.3,1) var(--delay) both;
            box-shadow:0 8px 26px rgba(0,0,0,.22);
            will-change: transform, opacity;
            background: var(--bg);
            /* 防止文字溢出 */
            max-width: 150px;
            word-wrap: break-word;
            text-align: center;
            line-height: 1.3;
        }
        
        /* 小屏幕优化 */
        @media (max-width: 480px) {
            .msg {
                padding: 6px 10px;
                border-radius: 10px;
                max-width: 120px;
            }
        }
        
        body.dark .msg{
            box-shadow:none;
            filter: drop-shadow(0 0 var(--glow-r1) var(--glow1, rgba(0,0,0,0)))
                    drop-shadow(0 0 var(--glow-r2) var(--glow2, rgba(0,0,0,0)));
        }

        @keyframes flight{
            0%{
                opacity:0;
                transform:translate(-50%,-50%) translate(var(--dx),var(--dy)) scale(.75) rotate(var(--rot));
            }
            18%{ opacity:1; }
            45%{
                transform:translate(-50%,-50%) translate(calc(var(--dx)*.2),calc(var(--dy)*.2)) scale(1.06);
            }
            70%{
                transform:translate(-50%,-50%) translate(calc(var(--dx)*1.15),calc(var(--dy)*1.15)) scale(.95) rotate(var(--rot));
            }
            88%{
                transform:translate(-50%,-50%) translate(calc(var(--heart-x)*.6),calc(var(--heart-y)*.6)) scale(.9) rotate(var(--heart-rot));
            }
            100%{
                opacity:1;
                transform:translate(-50%,-50%) translate(var(--heart-x),var(--heart-y)) scale(1) rotate(var(--heart-rot));
            }
        }

        .msg::before,.msg::after{
            content:''; 
            position:absolute; 
            left:50%; 
            top:0;
            background:inherit;
            border-radius:50px 50px 0 0;
            width:18px; 
            height:28px; 
            opacity:0;
            transition:opacity .28s ease;
            transform-origin:0 100%; 
            transform:rotate(-45deg); 
            z-index:0;
        }
        
        @media (max-width: 480px) {
            .msg::before, .msg::after {
                width: 14px;
                height: 22px;
            }
        }
        
        .msg::after{
            left:0; 
            transform-origin:100% 100%; 
            transform:rotate(45deg);
        }
        .msg.heart-mode{ color:#fff; }
        .msg .text{ 
            position:relative; 
            z-index:1;
        }
        .msg.heart-mode::before,.msg.heart-mode::after{ opacity:1; }

        .msg.locked{
            animation:none;
            transform:translate(-50%,-50%) translate(var(--heart-x),var(--heart-y)) scale(1) rotate(var(--heart-rot));
            opacity:1;
        }
        .msg.locked.pulse{ animation:pulse 2.2s ease-in-out 1; }
        .msg.locked::before,.msg.locked::after{ display:none; }
        body.dark .msg.locked{ filter:none; }
        .msg.locked .text{ text-shadow:0 1px 2px rgba(0,0,0,.12); }

        @keyframes pulse{
            0%,100%{ transform:translate(-50%,-50%) translate(var(--heart-x),var(--heart-y)) scale(1); }
            50%   { transform:translate(-50%,-50%) translate(var(--heart-x),var(--heart-y)) scale(1.08); }
        }

        /* 爆炸动画（核心破碎效果） */
        .msg.burst{ animation: burst 1.4s cubic-bezier(.17,.6,.2,1) forwards; }
        @keyframes burst{
            0%{ opacity:1; transform:translate(-50%,-50%) translate(var(--heart-x),var(--heart-y)) scale(1); filter:blur(0); }
            70%{ opacity:.9; transform:translate(-50%,-50%) translate(calc(var(--heart-x) + var(--bx)*0.7), calc(var(--heart-y) + var(--by)*0.7)) scale(.9) rotate(var(--rot)); filter:blur(.3px); }
            100%{ opacity:0; transform:translate(-50%,-50%) translate(calc(var(--heart-x) + var(--bx)), calc(var(--heart-y) + var(--by))) scale(.7) rotate(var(--rot)); filter:blur(1px); }
        }

        .center-title{
            position:absolute; 
            left:50%; 
            top:50%; 
            transform:translate(-50%,-50%);
            font-weight:800; 
            letter-spacing:.08em;
            font-size: var(--title-font-size);
            color:rgba(255,105,180,.7); 
            text-shadow:0 2px 10px rgba(255,105,180,.18);
            opacity:.0; 
            pointer-events:none;
            animation:titleIn 1.2s ease 0.8s both;
            text-align: center;
            /* 新增：文字流光效果 */
            background: linear-gradient(90deg, #ff4d6d, #ff8fa3, #ffccd5, #ff8fa3, #ff4d6d);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: titleIn 1.2s ease 0.8s both, textShine 3s linear infinite;
            padding: 0 10px;
            max-width: 90%;
        }
        
        body.dark .center-title{ 
            color:rgba(255,160,200,.9); 
            text-shadow:0 0 18px rgba(255,130,200,.35);
            background: linear-gradient(90deg, #ff4d6d, #ff8fa3, #ffccd5, #ff8fa3, #ff4d6d);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        @keyframes titleIn{ 
            from{opacity:0; transform:translate(-50%,-55%);} 
            to{opacity:.95; transform:translate(-50%,-50%);} 
        }
        
        /* 新增：文字流光动画 */
        @keyframes textShine {
            to {
                background-position: 200% center;
            }
        }

        .controls{ 
            position:absolute; 
            right:12px; 
            bottom:12px; 
            display:flex; 
            gap:8px; 
            align-items:center; 
            z-index: 100;
        }
        
        @media (max-width: 480px) {
            .controls {
                right: 8px;
                bottom: 8px;
                gap: 6px;
            }
        }
        
        .btn{
            padding:8px 12px; 
            border:none; 
            border-radius:8px;
            background:rgba(255,255,255,.5); 
            backdrop-filter:blur(8px);
            color:#222; 
            font-weight:600; 
            cursor:pointer;
            box-shadow:0 5px 20px rgba(0,0,0,.22);
            transition: all 0.3s ease;
            font-size: var(--button-font-size);
            /* 新增：按钮光晕效果 */
            position: relative;
            overflow: hidden;
        }
        
        @media (max-width: 480px) {
            .btn {
                padding: 6px 10px;
                border-radius: 6px;
            }
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 25px rgba(0,0,0,.3);
        }
        .btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .btn:hover::after {
            opacity: 1;
        }
        body.dark .btn{ background:rgba(255,255,255,.15); color:#fff; }

        .snow{
            position:fixed; 
            top:-10px; 
            color:white;
            user-select:none; 
            pointer-events:none;
            z-index:99; 
            text-shadow:0 0 8px rgba(255,255,255,.8);
            animation:snowfall linear forwards;
            font-size: 12px;
        }
        
        @keyframes snowfall{ 
            0%{ transform:translateY(0) rotate(0deg); opacity:1;} 
            100%{ transform:translateY(100vh) rotate(360deg); opacity:0;} 
        }

        #bgMusic { display: none; }
        
        /* 新增：音乐控制按钮 */
        .music-btn {
            position: absolute;
            left: 12px;
            bottom: 12px;
            padding: 8px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(8px);
            color: #222;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.22);
            width: 36px;
            height: 36px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            z-index: 100;
            /* 新增：按钮光晕效果 */
            position: relative;
            overflow: hidden;
        }
        
        @media (max-width: 480px) {
            .music-btn {
                left: 8px;
                bottom: 8px;
                width: 32px;
                height: 32px;
                padding: 6px;
            }
        }
        
        .music-btn:hover {
            transform: scale(1.1);
        }
        .music-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .music-btn:hover::after {
            opacity: 1;
        }
        body.dark .music-btn {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }
        
        /* 新增：表白按钮 */
        .confess-btn {
            position: absolute;
            left: 50%;
            bottom: 12px;
            transform: translateX(-50%);
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(135deg, #ff4d6d, #ff8fa3);
            color: white;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 77, 109, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
            font-size: var(--button-font-size);
            /* 新增：按钮光晕效果 */
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }
        
        @media (max-width: 480px) {
            .confess-btn {
                bottom: 8px;
                padding: 8px 16px;
                border-radius: 16px;
                font-size: clamp(11px, 1.8vmin, 14px);
            }
        }
        
        .confess-btn:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 7px 25px rgba(255, 77, 109, 0.6);
        }
        .confess-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .confess-btn:hover::after {
            opacity: 1;
        }
        
        /* 新增：隐藏的表白消息 */
        .confess-message {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 85%;
            display: none;
            z-index: 200;
            animation: fadeIn 0.5s ease;
            /* 新增：边框光效 */
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 20px rgba(255, 77, 109, 0.3);
        }
        
        @media (max-width: 480px) {
            .confess-message {
                padding: 15px;
                border-radius: 12px;
                max-width: 90%;
            }
        }
        
        body.dark .confess-message {
            background: rgba(30, 30, 30, 0.95);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 20px rgba(255, 77, 109, 0.5);
        }
        .confess-message h2 {
            color: #ff4d6d;
            margin-bottom: 12px;
            font-size: clamp(18px, 4vmin, 22px);
        }
        .confess-message p {
            margin-bottom: 8px;
            line-height: 1.5;
            font-size: clamp(14px, 2.5vmin, 16px);
        }
        .close-btn {
            margin-top: 12px;
            padding: 6px 16px;
            background: #ff4d6d;
            color: white;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--button-font-size);
            /* 新增：按钮光晕效果 */
            position: relative;
            overflow: hidden;
        }
        
        @media (max-width: 480px) {
            .close-btn {
                margin-top: 10px;
                padding: 5px 14px;
                border-radius: 14px;
            }
        }
        
        .close-btn:hover {
            background: #ff3355;
            transform: scale(1.05);
        }
        .close-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .close-btn:hover::after {
            opacity: 1;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* 新增：页面加载动画 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 1s ease;
        }
        
        .loading-content {
            text-align: center;
            color: white;
        }
        
        .loading-heart {
            font-size: clamp(40px, 10vmin, 60px);
            margin-bottom: 15px;
            animation: heartbeat 1.5s ease-in-out infinite both;
        }
        
        @keyframes heartbeat {
            from {
                transform: scale(1);
                transform-origin: center center;
                animation-timing-function: ease-out;
            }
            10% {
                transform: scale(0.91);
                animation-timing-function: ease-in;
            }
            17% {
                transform: scale(0.98);
                animation-timing-function: ease-out;
            }
            33% {
                transform: scale(0.87);
                animation-timing-function: ease-in;
            }
            45% {
                transform: scale(1);
                animation-timing-function: ease-out;
            }
        }
        
        .loading-text {
            font-size: clamp(18px, 4vmin, 24px);
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-heart">❤️</div>
            <div class="loading-text">正在加载我的心意...</div>
        </div>
    </div>
    
    <div class="stage" id="stage">
        <div class="center-title" id="title">致我心中的唯一 ❤️</div>
    </div>
    
    <button class="music-btn" id="musicToggle" title="音乐开关">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
        </svg>
    </button>
    
    <button class="confess-btn" id="confessBtn">我想对你说...</button>
    
    <div class="controls">
        <button class="btn" id="replay">切换主题</button>
    </div>
    
    <div class="confess-message" id="confessMessage">
        <h2>亲爱的，</h2>
        <p>从遇见你的那一刻起，我的世界就变得不一样了。</p>
        <p>你的笑容像阳光一样温暖，你的声音像音乐一样动听。</p>
        <p>和你在一起的每一刻，都让我感到无比幸福。</p>
        <p>我不知道未来会怎样，但我知道，我想和你一起走过。</p>
        <p>你愿意给我一个机会，让我成为你生命中的那个人吗？</p>
        <p style="margin-top: 12px; font-weight: bold; color: #ff4d6d; font-size: clamp(16px, 3vmin, 18px);">我喜欢你！</p>
        <button class="close-btn" id="closeMessage">关闭</button>
    </div>
    
    <audio id="bgMusic" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_7bdc844fa5.mp3?filename=romantic-piano-soft-music-144506.mp3" type="audio/mpeg">
    </audio>

<script>
// 替换为表白文字
const tips = [
    '我喜欢你','你是我的唯一','想和你在一起','爱你到永远','你是我生命中的光',
    '心动只为你','想牵你的手','想拥抱你','你让我心动','我的世界因你而美',
    '你是我的星辰','想和你共度余生','你是我最美的遇见','爱你无需理由',
    '想和你一起看星星','你是我心中的诗','想和你一起变老','你是我最珍贵的礼物',
    '我的心里只有你','想和你一起旅行','你是我每天的期待','爱你是我最幸福的事',
    '想和你分享一切','你是我生命的意义','想和你创造回忆','你是我最美的风景',
    '想和你一起做饭','你是我心中的温暖','想和你一起听雨','你是我永远的归宿',
    '想和你一起成长','你是我最大的幸运','想和你一起笑','你是我最深的思念',
    '想和你一起做梦','你是我心中的旋律','想和你一起看海','你是我永远的挚爱'
];

const stage  = document.getElementById('stage');
const replay = document.getElementById('replay');
const title  = document.getElementById('title');
const bgMusic = document.getElementById('bgMusic');
const musicToggle = document.getElementById('musicToggle');
const confessBtn = document.getElementById('confessBtn');
const confessMessage = document.getElementById('confessMessage');
const closeMessage = document.getElementById('closeMessage');
const loadingOverlay = document.getElementById('loadingOverlay');

let dark = false;
let eco = false;
let snowRunning = false;
let snowFrame;
let lastSnowTime = 0;
let snowIntervalMs = 700;
let snowMax = 80; // 减少雪花数量
let totalCurrent = 0;
let lockedCount = 0;
let musicPlaying = false;

// 调整动画方向，适应小屏幕
const directions = [
    {dx:'0vw',dy:'-60vh'},{dx:'0vw',dy:'60vh'},
    {dx:'-60vw',dy:'0vh'},{dx:'60vw',dy:'0vh'},
    {dx:'-50vw',dy:'-50vh'},{dx:'50vw',dy:'-50vh'},
    {dx:'-50vw',dy:'50vh'},{dx:'50vw',dy:'50vh'},
    {dx:'0vw',dy:'-40vh'},{dx:'0vw',dy:'40vh'},
    {dx:'-40vw',dy:'0vh'},{dx:'40vw',dy:'0vh'}
];

function rand(min,max){return Math.random()*(max-min)+min;}

function hexToRgba(hex,alpha=1){
    const h=hex.replace('#','');
    const short=h.length===3;
    const r=parseInt(short? h[0]+h[0] : h.slice(0,2),16);
    const g=parseInt(short? h[1]+h[1] : h.slice(2,4),16);
    const b=parseInt(short? h[2]+h[2] : h.slice(4,6),16);
    return `rgba(${r},${g},${b},${alpha})`;
}

function randomStyle(){
    const arr=[
        ['#ff758c','#ff7eb3'], ['#a18cd1','#fbc2eb'],
        ['#f6d365','#fda085'], ['#84fab0','#8fd3f4'],
        ['#f093fb','#f5576c'], ['#4facfe','#00f2fe'],
        ['#43e97b','#38f9d7'], ['#fa709a','#fee140'],
        ['#30cfd0','#330867'], ['#5ee7df','#b490ca']
    ];
    const [c1,c2]=arr[Math.floor(Math.random()*arr.length)];
    return {
        bg:`linear-gradient(135deg,${c1},${c2})`,
        glow1:hexToRgba(c1,0.55),
        glow2:hexToRgba(c2,0.35)
    };
}

function heartScale(){
    const minDim = Math.min(window.innerWidth, window.innerHeight);
    let s = Math.round(minDim * 0.018); // 减小爱心尺寸
    s = Math.max(6, Math.min(16, s)); // 调整最小最大值
    if (dark && eco) s = Math.max(6, Math.floor(s * 0.92));
    return s;
}

function centerYOffset(){
    const portrait = window.innerHeight > window.innerWidth;
    const minDim = Math.min(window.innerWidth, window.innerHeight);
    return portrait ? -minDim * 0.04 : 0; // 减小偏移量
}

function heartXY(t){
    const s = heartScale();
    const x = s * (16 * Math.sin(t)**3);
    const y = -s * (13*Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t));
    return {x: x+'px', y: (y + centerYOffset())+'px'};
}

function createMsg(i,total){
    const el = document.createElement('div');
    el.className = 'msg';

    const d = directions[Math.floor(Math.random()*directions.length)];
    el.style.setProperty('--dx', d.dx);
    el.style.setProperty('--dy', d.dy);
    el.style.setProperty('--rot', rand(-55,55)+'deg');

    const baseDur = dark && eco ? rand(5,6.5) : rand(5.5,7); // 缩短动画时间
    el.style.setProperty('--dur', baseDur+'s');
    el.style.setProperty('--delay', (i*0.08 + rand(0,0.25))+'s'); // 减少延迟
    
    const sty = randomStyle();
    el.style.setProperty('--bg', sty.bg);
    el.style.setProperty('--glow1', sty.glow1);
    el.style.setProperty('--glow2', sty.glow2);

    const t = (i / total) * Math.PI * 2;
    const {x,y} = heartXY(t);
    el.style.setProperty('--heart-x', x);
    el.style.setProperty('--heart-y', y);
    el.style.setProperty('--heart-rot', rand(-18,18)+'deg');

    const span = document.createElement('span');
    span.className = 'text';
    span.textContent = tips[Math.floor(Math.random()*tips.length)];
    el.appendChild(span);

    const delay = parseFloat(el.style.getPropertyValue('--delay'));
    const dur   = parseFloat(el.style.getPropertyValue('--dur'));
    const switchAt = delay + dur * 0.86;
    const switchTimer = setTimeout(()=>{ el.classList.add('heart-mode'); }, switchAt*1000);

    el.addEventListener('animationend',()=>{
        clearTimeout(switchTimer);
        el.classList.add('heart-mode','locked','pulse');
        el.style.willChange = 'auto';

        const spread = rand(100, 180); // 减小爆炸范围
        const ang    = rand(0, Math.PI*2);
        const bx = Math.cos(ang)*spread;
        const by = Math.sin(ang)*spread;
        el.style.setProperty('--bx', bx+'px');
        el.style.setProperty('--by', by+'px');

        lockedCount++;
        if(lockedCount===totalCurrent) onAllLocked();
    }, {once:true});

    stage.appendChild(el);
}

function finalBurst(){
    stage.querySelectorAll('.msg.locked').forEach(el=>{
        el.classList.remove('pulse');
        const jitter = rand(0, 150); // 减少抖动时间
        setTimeout(()=> el.classList.add('burst'), jitter);
        el.addEventListener('animationend',()=> el.remove(), {once:true});
    });
    title.style.opacity = 0;
}

function play(){
    stage.querySelectorAll('.msg').forEach(n=>n.remove());
    title.style.opacity = 0;

    const minDim = Math.min(window.innerWidth, window.innerHeight);
    let TOTAL;
    if (minDim <= 420) {
        TOTAL = dark ? (eco ? 50 : 70) : 90; // 大幅减少元素数量
    } else if (minDim <= 720) {
        TOTAL = dark ? (eco ? 60 : 80) : 110;
    } else {
        TOTAL = dark ? (eco ? 70 : 90) : 130;
    }
    totalCurrent = TOTAL;
    lockedCount = 0;
    for(let i=0;i<TOTAL;i++) createMsg(i,TOTAL);

    setTimeout(()=>{ title.style.opacity = 1; }, 1000); // 缩短等待时间
    playMusic();
}

function playMusic() {
    bgMusic.currentTime = 0;
    bgMusic.play().then(() => {
        musicPlaying = true;
        musicToggle.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 6h12v12H6z"/>
            </svg>
        `;
    }).catch(error => {
        console.log('音乐播放需要用户交互:', error);
        musicPlaying = false;
    });
}

function toggleMusic() {
    if (musicPlaying) {
        bgMusic.pause();
        musicPlaying = false;
        musicToggle.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
            </svg>
        `;
    } else {
        playMusic();
    }
}

function createSnow(){
    const snow=document.createElement('div');
    snow.className='snow';
    snow.textContent='❄';
    snow.style.left=(Math.random()*100)+'vw';
    snow.style.fontSize=(Math.random()*8+6)+'px'; // 减小雪花尺寸
    snow.style.opacity=(Math.random()*0.6+0.2); // 降低透明度
    const duration=(Math.random()*4+4); // 缩短持续时间
    snow.style.animationDuration=duration+'s';
    document.body.appendChild(snow);
    setTimeout(()=>snow.remove(),duration*1000);
}

function loopSnow(ts){
    if(!lastSnowTime) lastSnowTime=ts;
    const delta=ts-lastSnowTime;
    if(delta>snowIntervalMs){
        if(snowRunning){
            const count = document.querySelectorAll('.snow').length;
            if(count < snowMax) createSnow();
        }
        lastSnowTime=ts;
    }
    snowFrame=requestAnimationFrame(loopSnow);
}

function startSnow(){ snowRunning=true; lastSnowTime=0; loopSnow(); }
function stopSnow(){ 
    snowRunning=false; 
    cancelAnimationFrame(snowFrame); 
    document.querySelectorAll('.snow').forEach(s=>s.remove()); 
}

function decideEco(){
    const cores = navigator.hardwareConcurrency || 4;
    const mem = navigator.deviceMemory || 4;
    const area = window.innerWidth * window.innerHeight;
    return (cores <= 4) || (mem <= 4) || (area >= 2400*1440);
}

function applyMode(){
    document.body.classList.toggle('dark', dark);
    if(dark){
        eco = decideEco();
        document.body.classList.toggle('eco', eco);
        snowIntervalMs = eco ? 1000 : 700; // 增加雪花间隔
        snowMax = eco ? 60 : 100;
        startSnow();
    }else{
        stopSnow();
        document.body.classList.remove('eco');
    }
}

/* 所有元素锁定后触发破碎效果（核心修改） */
function onAllLocked(){
    if(dark){
        snowIntervalMs = eco ? 900 : 600;
        snowMax = eco ? 80 : 120;
    }

    // 延迟1.5秒后破碎（缩短等待时间）
    setTimeout(()=>{
        finalBurst();
    }, 1500);
}

// 初始播放
play();

// 重放按钮事件
replay.onclick = ()=>{ 
    dark = !dark; 
    applyMode(); 
    play(); 
};

// 音乐切换按钮事件
musicToggle.onclick = () => {
    toggleMusic();
};

// 表白按钮事件
confessBtn.onclick = () => {
    confessMessage.style.display = 'block';
};

// 关闭表白消息
closeMessage.onclick = () => {
    confessMessage.style.display = 'none';
};

// 窗口大小变化防抖重绘
let resizeTimer;
window.addEventListener('resize', ()=>{ 
    clearTimeout(resizeTimer); 
    resizeTimer = setTimeout(()=> play(), 150); 
});

// 首次点击触发音乐播放（解决浏览器限制）
document.addEventListener('click', () => {
    if (bgMusic.paused && !musicPlaying) {
        playMusic();
    }
}, { once: true });

// 新增：页面加载完成后初始化
window.addEventListener('load', () => {
    // 隐藏加载界面
    setTimeout(() => {
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
        }, 800); // 缩短等待时间
    }, 1500); // 缩短加载时间
});
</script>
</body>
</html>
