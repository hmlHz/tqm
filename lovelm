<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Love Story - 3D Particle System</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Microsoft YaHei', sans-serif; }
        
        /* è§†é¢‘éšè—ï¼Œåªç”¨äºè¯†åˆ« */
        #input-video {
            position: absolute;
            top: 0; left: 0; width: 320px; height: 240px;
            transform: scaleX(-1);
            opacity: 0; pointer-events: none; z-index: 0;
        }

        /* åŠ è½½é®ç½© */
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; justify-content: center; align-items: center;
            color: white; z-index: 999; flex-direction: column; transition: opacity 0.8s;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid #ff4d6d;
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* å…¨å±æŒ‰é’® */
        #fullscreen-btn {
            position: absolute; bottom: 20px; right: 20px; padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; border-radius: 30px; cursor: pointer; backdrop-filter: blur(5px); z-index: 100;
            transition: 0.3s;
        }
        #fullscreen-btn:hover { background: rgba(255, 77, 109, 0.4); }

        /* éŸ³ä¹æŒ‰é’® */
        #music-btn {
            position: absolute; top: 20px; right: 20px; width: 40px; height: 40px;
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; border-radius: 50%; cursor: pointer; backdrop-filter: blur(5px); z-index: 100;
            display: flex; justify-content: center; align-items: center; font-size: 18px;
            transition: 0.3s;
        }
        #music-btn:hover { background: rgba(255, 77, 109, 0.4); box-shadow: 0 0 15px rgba(255, 77, 109, 0.5); }
        .music-playing { animation: pulse-music 2s infinite; border-color: #ff4d6d !important; color: #ff4d6d !important; }
        
        @keyframes pulse-music {
            0% { box-shadow: 0 0 0 0 rgba(255, 77, 109, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 77, 109, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 77, 109, 0); }
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        #status-indicator {
            position: absolute; top: 20px; left: 20px; color: rgba(255,255,255,0.7);
            font-size: 14px; pointer-events: none; z-index: 100;
        }
        .status-dot {
            display: inline-block; width: 10px; height: 10px; background: #555;
            border-radius: 50%; margin-right: 8px; transition: 0.3s;
        }
        .active { background: #ff4d6d; box-shadow: 0 0 10px #ff4d6d; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div>æ­£åœ¨ç¼–ç»‡çˆ±çš„è®°å¿†...</div>
        <div style="font-size: 12px; color: #888; margin-top: 10px;">è¯·ç‚¹å‡»å±å¹•å¼€å¯éŸ³ä¹ä¸æ‰‹åŠ¿äº’åŠ¨</div>
    </div>

    <div id="status-indicator">
        <span class="status-dot" id="hand-dot"></span>
        <span id="status-text">ç­‰å¾…æ‰‹åŠ¿... (å¼ å¼€æ‰‹æŒæ”¾å¤§çˆ±æ„)</span>
    </div>

    <!-- éŸ³ä¹æ ‡ç­¾ï¼šè¯·ç¡®ä¿ç›®å½•ä¸‹æœ‰ love.mp3 æ–‡ä»¶ -->
    <audio id="bgm" loop preload="auto">
        <source src="C:\Users\MECHREVO\Music\ä½œåˆ«é›¨ - ä½ é—®æˆ‘ä¸ºä»€ä¹ˆé¡½å›ºè€Œä¸“ä¸€ï¼ˆBBé¼“ï¼‰.flac" type="audio/mp3">
        <source src="C:\Users\MECHREVO\Music\ä½œåˆ«é›¨ - ä½ é—®æˆ‘ä¸ºä»€ä¹ˆé¡½å›ºè€Œä¸“ä¸€ï¼ˆBBé¼“ï¼‰.flac" type="audio/mp4">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
    </audio>

    <video id="input-video" playsinline></video>
    
    <!-- æŒ‰é’®ç»„ -->
    <button id="music-btn" title="æ’­æ”¾/æš‚åœéŸ³ä¹">ğŸµ</button>
    <button id="fullscreen-btn">â›¶ å…¨å±æ²‰æµ¸æ¨¡å¼</button>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "@mediapipe/hands": "https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js",
                "@mediapipe/camera_utils": "https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js",
                "@mediapipe/drawing_utils": "https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js",
                "lil-gui": "https://unpkg.com/lil-gui@0.19.1/dist/lil-gui.esm.min.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import GUI from 'lil-gui';
        
        const loadScript = (src) => {
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = src; s.onload = resolve; s.onerror = reject;
                document.body.appendChild(s);
            });
        };

        // è¯­å½•åº“
        const loveTexts = [
            "ä½ é—®æˆ‘ä¸ºä»€ä¹ˆå›ºæ‰§è€Œä¸“ä¸€", "ä½ å“„å“„æˆ‘ï¼Œæˆ‘å“„å“„ä½ ï¼Œå°±è¿™æ ·ä¸€è¾ˆå­", "ç¥æˆ‘ä»¬çš„å¹¸ç¦ä¸æ—¶é—´é•¿é’",
            "åŸæ¥52å‘¨+1å¤©æ˜¯ä¸€å¹´", "ä»¥å¹´ä¸ºå•ä½å»æ‹çˆ±", "çˆ±åªæœ‰è¿›æ­¥æ²¡æœ‰é€€æ­¥", "ç¬¬å‡ ä¸ªä¸€ç™¾å¤©ä¾ç„¶å¾ˆæœ‰æ„Ÿè§‰",
            "2023å¹´10æœˆ14æ—¥ï¼Œè¿Ÿæ¥çš„å¹¸ç¦", "ç¬¬21ä¸ªå†¬å­£ï¼Œä¸å¦»é€šè¿‡", "ä¸€ç‰µå°±æ˜¯ä¸¤å¹´", "å†å¤šå±±ç›Ÿæµ·èª“ï¼Œä¸å¦‚é™ªä½ èµ°è¿‡æ˜¥å¤ç§‹å†¬",
            "è‡ªä¿¡å¹¸ç¦çš„æˆ‘å°±æ˜¯ç­”æ¡ˆ", "ä¸‰å¹´å‰çš„ç§‹å¤©ï¼Œç¬¬ä¸€æ¬¡è§é¢", "çœŸçˆ±æ— æ•Œï¼Œä¸¤å¹´ç¡®å®æ— æ•Œ", "23å¹´åˆ°25å¹´ï¼Œæˆ‘ä»¬è¿˜åœ¨ä¸€èµ·",
            "ä¸çŸ¥ä¸è§‰è¢«å® äº†ä¸¤å¹´", "æœŸå¾…ä¸‹ä¸€ä¸ªå››å­£è½®å›", "å°å°ä¸¤å‘¨å¹´ï¼Œè½»æ¾æ‹¿ä¸‹", "è°ˆäº†ä¸¤å¹´è¿˜æ˜¯çƒ­æ‹æœŸ",
            "ä½ åˆæ˜¯æˆ‘çš„21å²çš„å‡ åˆ†ä¹‹å‡ ", "å…œå…œè½¬è½¬èº«è¾¹æ€»æ˜¯ä½ ", "å»å¹´è¿™å¤©ä½ è¯´å¥½ï¼Œä»Šå¹´è¿˜åœ¨", "æ™®é€šçš„æ˜ŸæœŸä¸€ï¼Œå¼€å¯ç¬¬ä¸‰å¹´",
            "è¢«ä½ å–œæ¬¢å’Œå–œæ¬¢ä½ éƒ½å¥½å¹¸ç¦", "è¢«çˆ±çš„ä¸–ç•Œå¥½æ¼‚äº®", "åªä¸ºæ‰¾åˆ°ä¸€åŒä¸ºæˆ‘æµæ³ªçš„çœ¼ç›", "ä¸–ä¸Šæœ‰ä¸‰ä¸ªäººå–œæ¬¢ä½ ï¼šä»¥å‰ç°åœ¨æœªæ¥çš„æˆ‘",
            "çˆ±ä¸è¢«çˆ±çš„ç¬¬ä¸‰å¹´", "ä»ç§‹å¤©èµ°åˆ°äº†ç§‹å¤©", "å†¬å¤©æ¥äº†ï¼Œä½ è¿˜åœ¨ï¼Œæˆ‘ä¹Ÿè¿˜åœ¨", "ç¥ä½ çˆ±æˆ‘åˆ°å¤©è’åœ°è€",
            "å¹¸ç¦æ˜“å¦‚åæŒ", "ç‰›é€¼ï¼Œåˆè°ˆä¸€å¹´", "ç»´æŒä¸€æ®µæ°¸ä¹…çš„æ„Ÿæƒ…", "çˆ±çš„æ¸©åº¦åœ¨ç»§ç»­", "163å’Œ176çš„æ•…äº‹å†™äº†757å¤©",
            "çˆ±æˆ‘è¿™æœ¬ä¹¦ä½ ä¸€è¯»å°±æ˜¯ä¸¤å¹´", "è·ç¦»ç™¾å¹´å¥½åˆå€’è®¡æ—¶92å¹´", "Only only I", "é£é›¨æ¥ä¸´ä¹ŸåŒè¡Œ",
            "ä¸¤å¹´ä»¥æ¥ï¼Œä½ çš„çˆ±ä»æœªå˜è¿‡", "æˆ‘18é‚£å¹´å°±è·Ÿäº†ä½ ", "åˆä¸€å¹´ç§‹ï¼Œè¿˜æ˜¯å’Œæˆ‘æœ€çˆ±çš„", "ä¸å°å¿ƒæ©çˆ±äº†ä¸¤å¹´",
            "æ„¿å½¼æ­¤åšèº«åçš„æœ€åä¸€é“é˜²çº¿", "ç¬¬365é›†ï¼Œæˆ‘ä»¬æ˜¯å¯¹æ–¹ç‰¹åˆ«çš„äºº", "ä¸€å¤©ä¸€æœˆä¸€èµ·ä¸€å¹´åƒä¸åƒæ°¸è¿œ",
            "å…±é£Ÿä¸‰é¤çš„ç¬¬ä¸‰ä¸ªæ˜¥å¤ç§‹å†¬", "æ­Œé¢‚çˆ±çš„ä¼Ÿå¤§", "æ˜¥å¤ç§‹å†¬æ›¿æ¢çš„ç¬¬ä¸‰å¹´", "æ— è®ºå»å“ªå„¿éƒ½è¦å¸¦ä¸Šæˆ‘",
            "å¹¸ç¦æ˜¯ç”¨å¿ƒå…»çš„", "ä½ å“¼ç€æ°¸è¿œï¼Œæˆ‘å’Œç€ä¸å˜", "å¹´å°‘åˆæ—¶æƒ…æ¯”é‡‘åš", "ç¬¬ä¸‰ä¸ª365å¤©ï¼Œä¹Ÿåƒåˆšçƒ­æ‹"
        ];

        let scene, camera, renderer, particles, geometry, material;
        let textGroup;
        let controls;
        let handExpansion = 1.0; 
        const PARTICLE_COUNT = 16000;
        
        const targetPositions = new Float32Array(PARTICLE_COUNT * 3);
        const currentPositions = new Float32Array(PARTICLE_COUNT * 3);
        
        const params = {
            model: 'çˆ±å¿ƒ',
            color: '#ff4d6d',
            size: 0.18,
            speed: 0.06,
            sensitivity: 2.5,
            volume: 0.5 // éŸ³é‡æ§åˆ¶
        };

        // ==========================================
        // 1. éŸ³ä¹æ§åˆ¶é€»è¾‘
        // ==========================================
        function initAudio() {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('music-btn');
            
            bgm.volume = params.volume;

            const togglePlay = () => {
                if (bgm.paused) {
                    bgm.play().then(() => {
                        btn.innerText = "â¸";
                        btn.classList.add('music-playing');
                    }).catch(e => console.log("ç­‰å¾…ç”¨æˆ·äº¤äº’ä»¥æ’­æ”¾éŸ³é¢‘"));
                } else {
                    bgm.pause();
                    btn.innerText = "ğŸµ";
                    btn.classList.remove('music-playing');
                }
            };

            btn.addEventListener('click', togglePlay);
            
            // ä¸ºäº†åº”å¯¹æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾ç­–ç•¥ï¼Œé¦–æ¬¡ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®ä¹Ÿä¼šå°è¯•æ’­æ”¾
            document.body.addEventListener('click', function firstClick() {
                if (bgm.paused) togglePlay();
                document.body.removeEventListener('click', firstClick);
            }, { once: true });
        }

        // ==========================================
        // 2. åˆå§‹åŒ–åœºæ™¯
        // ==========================================
        function initScene() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050505, 0.02);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 35;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.8;

            textGroup = new THREE.Group();
            scene.add(textGroup);

            initParticles();
            initGUI();
            initAudio(); // å¯åŠ¨éŸ³é¢‘ç³»ç»Ÿ
            
            window.addEventListener('resize', onWindowResize);
            document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
        }

        // ==========================================
        // 3. æ–‡å­—ç²¾çµä¸è´´å›¾
        // ==========================================
        function createTextSprite(message) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const width = 1024; const height = 128; 
            canvas.width = width; canvas.height = height;

            ctx.font = `bold 50px "Microsoft YaHei", Arial`;
            ctx.fillStyle = "rgba(255, 255, 255, 1.0)";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.shadowColor = "rgba(255, 77, 109, 1.0)";
            ctx.shadowBlur = 15;
            ctx.fillText(message, width / 2, height / 2);

            const texture = new THREE.CanvasTexture(canvas);
            const spriteMaterial = new THREE.SpriteMaterial({ 
                map: texture, transparent: true, opacity: 0.9, depthWrite: false
            });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(12, 1.5, 1); 
            return sprite;
        }

        function updateTextsForModel(type) {
            while(textGroup.children.length > 0){ 
                let child = textGroup.children[0];
                child.material.map.dispose(); child.material.dispose(); textGroup.remove(child); 
            }

            if (type !== 'çˆ±å¿ƒ') return;

            // æ˜¾ç¤ºæ‰€æœ‰æ–‡å­—ï¼Œæˆ–è€…éƒ¨åˆ†éšæœº
            loveTexts.forEach((text) => {
                const sprite = createTextSprite(text);
                
                // çˆ±å¿ƒåˆ†å¸ƒ
                const t = Math.PI - 2 * Math.PI * Math.random(); 
                let x = 16 * Math.pow(Math.sin(t), 3);
                let y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                let z = (Math.random() - 0.5) * 8;

                const scale = 0.6 + Math.random() * 0.6; 
                x *= scale; y *= scale; z *= scale;

                sprite.position.set(x, y, z);
                sprite.scale.multiplyScalar(0.4 + Math.random() * 0.4);
                textGroup.add(sprite);
            });
        }

        // ==========================================
        // 4. ç²’å­ç³»ç»Ÿ
        // ==========================================
        function createTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 32; canvas.height = 32;
            const context = canvas.getContext('2d');
            const gradient = context.createRadialGradient(16, 16, 0, 16, 16, 16);
            gradient.addColorStop(0, 'rgba(255,255,255,1)');
            gradient.addColorStop(0.2, 'rgba(255,255,255,0.8)');
            gradient.addColorStop(0.6, 'rgba(255,255,255,0.2)');
            gradient.addColorStop(1, 'rgba(0,0,0,0)');
            context.fillStyle = gradient;
            context.fillRect(0, 0, 32, 32);
            return new THREE.Texture(canvas);
        }

        function initParticles() {
            geometry = new THREE.BufferGeometry();
            for (let i = 0; i < PARTICLE_COUNT * 3; i++) currentPositions[i] = (Math.random() - 0.5) * 50;
            geometry.setAttribute('position', new THREE.BufferAttribute(currentPositions, 3));

            const tex = createTexture();
            tex.needsUpdate = true;

            material = new THREE.PointsMaterial({
                size: params.size,
                color: new THREE.Color(params.color),
                map: tex,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            calculateShape('çˆ±å¿ƒ');
        }

        function calculateShape(type) {
            updateTextsForModel(type);
            const rRand = () => Math.random();
            const sRand = () => Math.random() - 0.5;

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                let x, y, z;
                if (type === 'çˆ±å¿ƒ') {
                    const t = Math.PI - 2 * Math.PI * rRand(); 
                    x = 16 * Math.pow(Math.sin(t), 3);
                    y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                    z = sRand() * 6;
                    const fill = rRand(); x *= fill; y *= fill; z *= fill; 
                } 
                else if (type === 'åœŸæ˜Ÿ') {
                    if (rRand() < 0.3) {
                        const theta = rRand() * Math.PI * 2, phi = Math.acos(2 * rRand() - 1), r = 8;
                        x = r * Math.sin(phi) * Math.cos(theta);
                        y = r * Math.sin(phi) * Math.sin(theta);
                        z = r * Math.cos(phi);
                    } else {
                        const angle = rRand() * Math.PI * 2, dist = 12 + rRand() * 6;
                        x = Math.cos(angle) * dist; z = Math.sin(angle) * dist; y = sRand() * 0.5;
                        const tilt = 0.5, _y = y * Math.cos(tilt) - z * Math.sin(tilt), _z = y * Math.sin(tilt) + z * Math.cos(tilt);
                        y = _y; z = _z;
                    }
                }
                else if (type === 'èŠ±æœµ') {
                    const angle = i * 0.1, r = 0.5 * Math.sqrt(i);
                    x = r * Math.cos(angle); y = r * Math.sin(angle); z = Math.sin(r/2) * 5 - 5;
                }
                else if (type === 'å®‡å®™çƒä½“') {
                     const theta = 2 * Math.PI * rRand(), phi = Math.acos(2 * rRand() - 1), r = 15;
                     x = r * Math.sin(phi) * Math.cos(theta); y = r * Math.sin(phi) * Math.sin(theta); z = r * Math.cos(phi);
                }
                else if (type === 'çƒŸèŠ±') {
                     const theta = 2 * Math.PI * rRand(), phi = Math.acos(2 * rRand() - 1), r = 20 * Math.cbrt(rRand());
                     x = r * Math.sin(phi) * Math.cos(theta); y = r * Math.sin(phi) * Math.sin(theta); z = r * Math.cos(phi);
                }
                targetPositions[i * 3] = x || 0; targetPositions[i * 3 + 1] = y || 0; targetPositions[i * 3 + 2] = z || 0;
            }
        }

        // ==========================================
        // 5. GUI ä¸ äº¤äº’
        // ==========================================
        function initGUI() {
            const gui = new GUI({ title: 'çˆ±çš„æ§åˆ¶å°' });
            
            gui.add(params, 'model', ['çˆ±å¿ƒ', 'åœŸæ˜Ÿ', 'èŠ±æœµ', 'å®‡å®™çƒä½“', 'çƒŸèŠ±']).name('å½¢æ€åˆ‡æ¢').onChange(val => calculateShape(val));
            gui.addColor(params, 'color').name('ç²’å­é¢œè‰²').onChange(val => material.color.set(val));
            gui.add(params, 'size', 0.05, 0.5).name('ç²’å­å¤§å°').onChange(v => material.size = v);
            gui.add(params, 'speed', 0.01, 0.2).name('å˜æ¢é€Ÿåº¦');
            gui.add(params, 'sensitivity', 1.0, 5.0).name('æ‰‹åŠ¿çµæ•åº¦');
            
            // å¢åŠ éŸ³é‡æ§åˆ¶
            gui.add(params, 'volume', 0.0, 1.0).name('èƒŒæ™¯éŸ³ä¹éŸ³é‡').onChange(val => {
                const bgm = document.getElementById('bgm');
                if(bgm) bgm.volume = val;
            });
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // ==========================================
        // 6. æ‰‹åŠ¿è¯†åˆ«
        // ==========================================
        async function initHandTracking() {
            await Promise.all([
                loadScript("https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"),
                loadScript("https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"),
                loadScript("https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"),
                loadScript("https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js")
            ]);

            const videoElement = document.getElementById('input-video');
            const hands = new window.Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});

            hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
            hands.onResults(onHandsResults);

            const cameraUtils = new window.Camera(videoElement, {
                onFrame: async () => await hands.send({image: videoElement}),
                width: 320, height: 240
            });

            cameraUtils.start().then(() => {
                document.getElementById('loader').style.opacity = 0;
                setTimeout(() => document.getElementById('loader').style.display = 'none', 800);
            });
        }

        function onHandsResults(results) {
            const statusDot = document.getElementById('hand-dot');
            const statusText = document.getElementById('status-text');

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                statusDot.classList.add('active');
                const landmarks = results.multiHandLandmarks[0];
                const thumb = landmarks[4]; const index = landmarks[8];
                const dist = Math.sqrt(Math.pow(thumb.x - index.x, 2) + Math.pow(thumb.y - index.y, 2));
                
                const minD = 0.03, maxD = 0.25;
                const normalized = (Math.max(minD, Math.min(maxD, dist)) - minD) / (maxD - minD);
                const targetScale = 0.5 + normalized * params.sensitivity; 
                
                statusText.innerText = normalized < 0.2 ? "çŠ¶æ€: å‘µæŠ¤ (æåˆ)" : "çŠ¶æ€: ç»½æ”¾ (å¼ å¼€)";
                handExpansion = THREE.MathUtils.lerp(handExpansion, targetScale, 0.1);
            } else {
                statusDot.classList.remove('active');
                statusText.innerText = "ç­‰å¾…ä½ çš„åŒæ‰‹...";
                handExpansion = THREE.MathUtils.lerp(handExpansion, 1.0, 0.05);
            }
        }

        // ==========================================
        // 7. åŠ¨ç”»å¾ªç¯
        // ==========================================
        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            const positions = particles.geometry.attributes.position.array;
            const mixSpeed = params.speed;

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const px = i * 3, py = i * 3 + 1, pz = i * 3 + 2;
                
                const targetX = targetPositions[px] * handExpansion;
                const targetY = targetPositions[py] * handExpansion;
                const targetZ = targetPositions[pz] * handExpansion;

                positions[px] += (targetX - positions[px]) * mixSpeed;
                positions[py] += (targetY - positions[py]) * mixSpeed;
                positions[pz] += (targetZ - positions[pz]) * mixSpeed;
            }

            particles.geometry.attributes.position.needsUpdate = true;
            particles.rotation.y += 0.002;

            if (textGroup) {
                textGroup.scale.set(handExpansion, handExpansion, handExpansion);
                textGroup.rotation.y += 0.002;
            }

            renderer.render(scene, camera);
        }

        initScene();
        initHandTracking();
        animate();

    </script>
</body>
</html>
